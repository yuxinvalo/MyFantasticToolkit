# Period Variance Report
This plugin is used to generate period variance report according to user's request. 
This plugin is similar to comparison variance report in perspective of UI design. 

## Plugin UI
This plugin requires a scroll area. For the UI below, we need to place them **in order**.
In this scroll area, we have:
1. A textarea to show the bigquery SQL, user can edit the SQL in this textarea.
2. A File chooser to choose the csv file downloaded from 1.
3. A log viewer to show the process.
4. A button to run the report generation. 

## Configuration

1. last_original_csv_path: the last csv file path user choose. 
2. report_save_path: the path to save the final report.

```json
{
  "plugin_info": {
    "name": "period_variance_report",
    "display_name": "Period Variance Report",
    "version": "1.0.0",
    "author": "Tearsyu",
    "description": "Period Variance Report, Semi-automated solution for monthly related user requests, protecting your eyes starts with you."
  },
  "available_config": {
    "enabled": true,
    "report_save_path": "reports"
  },
  "settings": {
    "last_original_csv_path": "",
  }
}
```
## Loggings
In the log viewer, we need to show the process of report generation, including:
1. The total number of filtered lines
2. For each line, show the process of getting the **table_name** **balance** and **column_name**
    1. The bigquery sql will be executed
    2. The result of sql execution will be shown
    3. For the exception, warning the user the situation, follow the process to handle the exception.
    4. For each line, adding spliter to make it readable, also adding the emoji. 

## Excel Format
There are 2 csv files to provide. 
1. The original csv file downloaded from bigquery.
2. The final report csv file of report, this report is generated by this plugin, means, after clicking generate report. 

The final report csv file contains all the columns of original csv file, plus:
    1. **column_name**: the column name of the line(from original csv file)
    2. **table_name**: the table name of the line(from original csv file)
    3. **balance**: the balance value of the line (from composed SQL executed to get the balance value)
    
## Process
This section describes the process of how the original csv file provided to final report csv file. 
All the SQL required and mappings are defined in static_values.py, you don't need to mind the content as original context is too long, I will replace it later. 
1. User choose the original csv file.
2. User review and edit the bigquery SQL:PVR_ORIGINAL_SQL with replacing the first reporting_date_a with last month date and second reporting_date_b with prior month last date in textarea.
3. Waiting for user to select the original csv file exported from GCP bigquery(This step requires priviledge account, so it must have done by user.)
4. User click the generate report button.
5. Plugin read the original csv file as dataframe, convert data as string type, filter data:
    1. Remove the line with column "radar_country_code" which is "GB", "CA", "HK", "HS"
    2. Only keep the line with column "file_freq" which is "Monthly"
    3. Only keep the line with column "breach_value" which is "Breach"
6. Based on the filtered dataframe, mapping the filtered dataframe column "Col_output" with this stable table:PVR_COL_MAPPINGS to get the **column_name**:   
    | **column_name** | **Col_output** |
    |-----------------|----------------|
    | G_L_REP_BK_VALUE      | book_value_in_functional_currency |
    | G_L_REP_PSMRK_MRKT_AMT      | clean_economic_value_in_functional_currency |
    | F_L_REP_ACRD_INT      | accrued_interest_amount_in_functional_currency |
    | F_L_REP_EOP_BAL      | gross_gl_balance_in_functional_currency |
    | E_L_REP_UNWGHTD_UNDRN_CMMT      | undrawn_balance_in_functional_currency |   
    
7. Based on 6, we can get the **table_name** with the rule below:
    1. for each line, extract the "radar_country_code", "radar_group_sys_id", "column_name"
    2. compose the sql:EXTRACT_TABLE_NAME_SQL below, where mif_{column_name_letter} is the first letter of column_name, ex G_L.. --> mif_g, reporting_date is the last date of last month, ex: 2025-08-31
    ```sql
        SELECT...
        FROM XXX
        WHERE provider_country_code = "{radar_country_code}")
        AND
        reporting_date = "{reporting_date}"
        AND
        group_sys_id = "{radar_group_sys_id}"
        AND
        file_type like 'mif_{column_name_letter}%'
    ```
    Exception situation: if Col_output is "0", and the table_name_source is "MIF_<?>_*", the column_name_letter will be "mif_<?>", and uses the same sql:EXTRACT_TABLE_NAME_SQL above to get the **table_name**.
    3. execute the sql in using gcp bigquery client, fetch the result and extract the column name "abc.table_uuid" as the **table_name**. If the result has more than 1 column, warning the user and use the first row's "abc.table_uuid" as **table_name**.
    4. execute the sql:GET_BALANCE_SQL below to get the balance value:
    ```sql
        SELECT CAST(sum({column_name}) AS NUMERIC) FROM DATAHUB.{table_name}
    ```
    Exception situation: if Col_output is "0" and table_name_source is "MIF_<?>_*", then the sql will be:
    ```sql
        SELECT count(*) FROM DATAHUB.{table_name}
    ```
8. Save this filtered csv file with **column_name** and **table_name**, **balance** added to the path, refer "config.json", with the name period_variance_report_<timestamp>.csv