# -*- coding: utf-8 -*-
"""
LittleCapturer - æˆªå›¾åŠŸèƒ½æ¨¡å—
æä¾›å±å¹•æˆªå›¾çš„æ ¸å¿ƒåŠŸèƒ½
"""

from PySide6.QtWidgets import QWidget
from PySide6.QtCore import QObject, Signal, QRect
from PySide6.QtGui import QPixmap
from typing import Optional, Callable

from utils.logger import logger


class ScreenCapture(QObject):
    """å±å¹•æˆªå›¾ç±»"""
    
    # ä¿¡å·å®šä¹‰
    capture_started = Signal()  # æˆªå›¾å¼€å§‹ä¿¡å·
    capture_completed = Signal(QPixmap, QRect)  # æˆªå›¾å®Œæˆä¿¡å· (å›¾ç‰‡, åŒºåŸŸ)
    capture_cancelled = Signal()  # æˆªå›¾å–æ¶ˆä¿¡å·
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self._is_capturing = False
        self._capture_window = None
        
        logger.debug("[SCREENSHOT] ğŸ“¸ ScreenCapture initialized")
    
    def start_capture(self) -> bool:
        """å¼€å§‹æˆªå›¾
        
        Returns:
            bool: æ˜¯å¦æˆåŠŸå¼€å§‹æˆªå›¾
        """
        try:
            if self._is_capturing:
                logger.warning("[SCREENSHOT] âš ï¸ Capture already in progress")
                return False
            
            self._is_capturing = True
            logger.info("[SCREENSHOT] ğŸ¯ Starting screen capture")
            
            # TODO: å®ç°æˆªå›¾é€»è¾‘
            # 1. åˆ›å»ºå…¨å±è¦†ç›–çª—å£
            # 2. æ•è·å±å¹•å†…å®¹
            # 3. æ˜¾ç¤ºé€‰æ‹©åŒºåŸŸç•Œé¢
            
            self.capture_started.emit()
            return True
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to start capture: {e} - {traceback.format_exc()}")
            self._is_capturing = False
            return False
    
    def cancel_capture(self):
        """å–æ¶ˆæˆªå›¾"""
        try:
            if not self._is_capturing:
                return
            
            logger.info("[SCREENSHOT] ğŸš« Cancelling screen capture")
            self._is_capturing = False
            
            # TODO: æ¸…ç†æˆªå›¾ç›¸å…³èµ„æº
            
            self.capture_cancelled.emit()
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to cancel capture: {e} - {traceback.format_exc()}")
    
    def capture_area(self, rect: QRect) -> Optional[QPixmap]:
        """æˆªå–æŒ‡å®šåŒºåŸŸ
        
        Args:
            rect: æˆªå›¾åŒºåŸŸ
            
        Returns:
            QPixmap: æˆªå›¾ç»“æœï¼Œå¤±è´¥è¿”å›None
        """
        try:
            logger.info(f"[SCREENSHOT] ğŸ“· Capturing area: {rect}")
            
            # TODO: å®ç°åŒºåŸŸæˆªå›¾é€»è¾‘
            # 1. è·å–å±å¹•å†…å®¹
            # 2. è£å‰ªæŒ‡å®šåŒºåŸŸ
            # 3. è¿”å›æˆªå›¾ç»“æœ
            
            # ä¸´æ—¶è¿”å›ç©ºçš„QPixmap
            pixmap = QPixmap()
            
            if not pixmap.isNull():
                self.capture_completed.emit(pixmap, rect)
                logger.info("[SCREENSHOT] âœ… Area capture completed")
            
            return pixmap
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to capture area: {e} - {traceback.format_exc()}")
            return None
        finally:
            self._is_capturing = False
    
    def capture_full_screen(self) -> Optional[QPixmap]:
        """å…¨å±æˆªå›¾
        
        Returns:
            QPixmap: æˆªå›¾ç»“æœï¼Œå¤±è´¥è¿”å›None
        """
        try:
            logger.info("[SCREENSHOT] ğŸ–¥ï¸ Capturing full screen")
            
            # TODO: å®ç°å…¨å±æˆªå›¾é€»è¾‘
            
            # ä¸´æ—¶è¿”å›ç©ºçš„QPixmap
            pixmap = QPixmap()
            
            if not pixmap.isNull():
                logger.info("[SCREENSHOT] âœ… Full screen capture completed")
            
            return pixmap
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to capture full screen: {e} - {traceback.format_exc()}")
            return None
    
    def is_capturing(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦æ­£åœ¨æˆªå›¾
        
        Returns:
            bool: æ˜¯å¦æ­£åœ¨æˆªå›¾
        """
        return self._is_capturing
    
    def get_screen_geometry(self) -> QRect:
        """è·å–å±å¹•å‡ ä½•ä¿¡æ¯
        
        Returns:
            QRect: å±å¹•åŒºåŸŸ
        """
        try:
            # TODO: å®ç°è·å–å±å¹•å‡ ä½•ä¿¡æ¯
            # è€ƒè™‘å¤šæ˜¾ç¤ºå™¨æƒ…å†µ
            
            # ä¸´æ—¶è¿”å›é»˜è®¤å€¼
            return QRect(0, 0, 1920, 1080)
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to get screen geometry: {e} - {traceback.format_exc()}")
            return QRect()


class CaptureWindow(QWidget):
    """æˆªå›¾é€‰æ‹©çª—å£"""
    
    # ä¿¡å·å®šä¹‰
    area_selected = Signal(QRect)  # åŒºåŸŸé€‰æ‹©å®Œæˆä¿¡å·
    capture_cancelled = Signal()  # å–æ¶ˆæˆªå›¾ä¿¡å·
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self._setup_ui()
        self._setup_events()
        
        logger.debug("[SCREENSHOT] ğŸªŸ CaptureWindow initialized")
    
    def _setup_ui(self):
        """è®¾ç½®UIç•Œé¢"""
        try:
            # TODO: è®¾ç½®å…¨å±è¦†ç›–çª—å£
            # 1. è®¾ç½®çª—å£å±æ€§ï¼ˆæ— è¾¹æ¡†ã€ç½®é¡¶ç­‰ï¼‰
            # 2. è®¾ç½®é¼ æ ‡æ ·å¼
            # 3. è®¾ç½®èƒŒæ™¯
            
            self.setWindowTitle("LittleCapturer - é€‰æ‹©æˆªå›¾åŒºåŸŸ")
            logger.debug("[SCREENSHOT] ğŸ¨ CaptureWindow UI setup completed")
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to setup UI: {e} - {traceback.format_exc()}")
    
    def _setup_events(self):
        """è®¾ç½®äº‹ä»¶å¤„ç†"""
        try:
            # TODO: è®¾ç½®é¼ æ ‡äº‹ä»¶å¤„ç†
            # 1. é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
            # 2. é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            # 3. é¼ æ ‡é‡Šæ”¾äº‹ä»¶
            # 4. é”®ç›˜äº‹ä»¶ï¼ˆESCå–æ¶ˆï¼‰
            
            logger.debug("[SCREENSHOT] âš¡ CaptureWindow events setup completed")
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to setup events: {e} - {traceback.format_exc()}")
    
    def show_capture_window(self):
        """æ˜¾ç¤ºæˆªå›¾é€‰æ‹©çª—å£"""
        try:
            logger.info("[SCREENSHOT] ğŸ‘ï¸ Showing capture window")
            
            # TODO: æ˜¾ç¤ºå…¨å±é€‰æ‹©çª—å£
            # 1. è·å–å±å¹•æˆªå›¾ä½œä¸ºèƒŒæ™¯
            # 2. æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
            # 3. è®¾ç½®ç„¦ç‚¹
            
            self.show()
            self.raise_()
            self.activateWindow()
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to show capture window: {e} - {traceback.format_exc()}")
    
    def hide_capture_window(self):
        """éšè—æˆªå›¾é€‰æ‹©çª—å£"""
        try:
            logger.info("[SCREENSHOT] ğŸ™ˆ Hiding capture window")
            self.hide()
            
        except Exception as e:
            import traceback
            logger.error(f"[SCREENSHOT] âŒ Failed to hide capture window: {e} - {traceback.format_exc()}")